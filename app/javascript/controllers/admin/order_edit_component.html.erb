<%# app/components/admin/order_edit_component.html.erb %>
<div class="max-w-5xl mx-auto py-8 px-4" data-controller="admin--order-show-component">
  
  <%# 1. 顶部导航与状态 - 统一品牌蓝 %>
  <div class="mb-6 flex justify-between items-center px-1 border-b border-slate-100 pb-5">
    <div class="flex items-center gap-3">
      <%= link_to unsettled_admin_orders_path, 
                  data: { turbo_frame: "main_content" },
                  class: "p-2 bg-white border-2 border-slate-100 rounded-lg text-slate-400 hover:text-[#0066b3] hover:border-[#0066b3] transition-all shadow-sm" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
        </svg>
      <% end %>
      <div>
        <h1 class="text-xl font-black text-slate-800 tracking-tight">订单账务审查</h1>
        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-0.5 font-mono">单据编号: <%= @order.order_no %></p>
      </div>
    </div>
    
    <div class="flex flex-col items-end">
      <span class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 text-right italic">账务处理状态</span>
      <div class="px-4 py-1.5 <%= @order.is_settled ? 'bg-emerald-50 border-emerald-100 text-emerald-600' : 'bg-blue-50 border-blue-100 text-[#0066b3]' %> text-[11px] font-black rounded-lg uppercase tracking-wider border">
        <%= status_label %>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <%# 左侧主内容区 %>
    <div class="lg:col-span-2 space-y-6">
      <%# 业务规格卡片 %>
      <div class="bg-white border-2 border-slate-200 rounded-2xl overflow-hidden shadow-sm">
        <div class="p-6 border-b-2 border-slate-50 flex items-center justify-between">
          <h3 class="text-sm font-black text-slate-800 flex items-center gap-2">
            <div class="w-1.5 h-4 bg-[#0066b3] rounded-full"></div>
            业务规格信息
          </h3>
        </div>
        
        <div class="p-8 grid grid-cols-1 md:grid-cols-3 gap-8 text-slate-700">
          <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 tracking-widest ml-1">服务类型</label><p class="text-sm font-bold px-1"><%= @order.service_type.presence || "标准服务" %></p></div>
          <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 tracking-widest ml-1">产品分类</label><p class="text-sm font-bold text-[#0066b3] px-1"><%= @order.category_name %></p></div>
          <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 tracking-widest ml-1">生产数量</label><p class="text-sm font-bold font-mono px-1"><%= @order.quantity.to_i %> PCS</p></div>
          
          <div class="space-y-1 border-t border-slate-50 pt-4"><label class="text-[10px] font-black text-slate-400 tracking-widest ml-1">单价</label><p class="text-sm font-bold font-mono text-orange-600 px-1">¥ <%= number_with_precision(@order.unit_price, precision: 4) %></p></div>
          <div class="space-y-1 border-t border-slate-50 pt-4"><label class="text-[10px] font-black text-slate-400 tracking-widest ml-1">预估运费</label><p class="text-sm font-bold font-mono px-1">¥ <%= number_with_precision(@order.delivery_fee, precision: 2) %></p></div>
          <div class="space-y-1 border-t border-slate-50 pt-4"><label class="text-[10px] font-black text-slate-400 tracking-widest ml-1">付款方式</label><p class="text-sm font-bold uppercase px-1"><%= @order.payment_method || "未指定" %></p></div>
        </div>
      </div>

      <%# 稿件资料卡片 %>
      <div class="bg-white border-2 border-slate-200 rounded-2xl overflow-hidden shadow-sm">
        <div class="p-6 border-b-2 border-slate-50 flex items-center gap-2">
          <div class="w-1.5 h-4 bg-slate-300 rounded-full"></div>
          <h3 class="text-sm font-black text-slate-800">关联稿件资料</h3>
        </div>
        <div class="p-8">
          <div class="group flex items-center justify-between p-5 bg-slate-50 rounded-xl border-2 border-dashed border-slate-200 hover:border-[#0066b3]/30 transition-colors">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-[#0066b3] shadow-sm border border-slate-100">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
              </div>
              <div>
                <p class="text-sm font-black text-slate-700 leading-tight"><%= @order.draft_name || @order.draft&.name %></p>
                <p class="text-[9px] text-slate-400 font-bold tracking-wider mt-1">设计中心关联文件</p>
              </div>
            </div>
            <% if @order.draft&.file&.attached? %>
              <%= link_to rails_blob_path(@order.draft.file, disposition: "attachment"), data: { turbo: false }, class: "flex items-center gap-2 px-5 py-2.5 bg-white border border-slate-200 text-[#0066b3] text-[10px] font-black rounded-lg hover:bg-[#0066b3] hover:text-white transition-all active:scale-95 shadow-sm" do %>
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                下载稿件
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <%# 右侧财务核算边栏 %>
    <div class="space-y-6">
      <div class="bg-slate-900 rounded-2xl p-7 text-white shadow-xl relative overflow-hidden font-bold">
        <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/5 rounded-full blur-2xl"></div>
        
        <label class="text-[9px] font-black text-slate-500 uppercase tracking-[0.2em] mb-4 block">账目结算总计</label>
        <div class="flex items-baseline gap-1.5 mb-8">
          <span class="text-xl font-light text-slate-500">¥</span>
          <span class="text-4xl font-black tracking-tighter text-white leading-none">
            <%= number_with_precision(@order.amount, precision: 2) %>
          </span>
        </div>
        
        <div class="space-y-4 pt-6 border-t border-white/10 text-[11px]">
          <div class="flex justify-between items-center"><span class="text-slate-500 font-bold">归属客户</span><span class="tracking-wide"><%= @order.customer_name %></span></div>
          <div class="flex justify-between items-center"><span class="text-slate-500 font-bold">稿件设计</span><span class="text-amber-400"><%= designer_name %></span></div>
          <div class="flex justify-between items-center"><span class="text-slate-500 font-bold">制单负责人</span><span class="text-blue-400"><%= @order.staff&.name || "系统默认" %></span></div>
          
          <% if @order.is_settled %>
            <div class="flex justify-between items-center pt-2 mt-2 border-t border-white/5">
              <span class="text-slate-500 font-bold">结算时间</span>
              <span class="text-emerald-400 font-mono tracking-tighter">
                <%= @order.updated_at.strftime("%Y-%m-%d %H:%M") %>
              </span>
            </div>
          <% end %>
        </div>
      </div>

      <%# 操作区 %>
      <% unless @order.is_settled %>
        <div class="bg-white border-2 border-slate-200 rounded-2xl p-6 shadow-sm">
          <div class="flex flex-col gap-4">
            <div class="flex items-center gap-2 mb-1">
              <span class="w-1 h-3.5 bg-[#0066b3] rounded-full"></span>
              <span class="text-[11px] font-black text-slate-700 tracking-widest">财务入账指令</span>
            </div>
            
            <p class="text-[10px] text-slate-400 font-bold leading-relaxed mb-2 italic">
              请在核实规格与金额无误后执行结算，该操作将正式计入财务流水。
            </p>

            <div class="relative group/popover w-full">
              <%# 触发按钮：改为品牌蓝边框样式 %>
              <button type="button" class="w-full py-3.5 bg-white border-2 border-[#0066b3] text-[#0066b3] text-[11px] font-black rounded-xl shadow-sm hover:bg-blue-50 active:scale-[0.98] transition-all tracking-[0.2em] cursor-pointer">
                执行结算入账
              </button>

              <%# 确认气泡 - 按钮样式复刻 Navbar Active %>
              <div class="invisible opacity-0 group-hover/popover:visible group-hover/popover:opacity-100 
                          absolute bottom-full left-1/2 -translate-x-1/2 mb-4 z-[70] transition-all duration-200 translate-y-2 group-hover/popover:translate-y-0">
                <div class="bg-white border border-slate-200 shadow-2xl rounded-xl p-3 flex flex-col items-center gap-2 whitespace-nowrap min-w-[200px] overflow-hidden">
                  <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest px-2 py-1">确认提交结算？</p>
                  
                  <%# 核心：复用 Navbar 品牌样式 %>
                  <div class="relative w-full overflow-hidden rounded-lg">
                    <%= button_to admin_order_path(@order), 
                                  method: :patch,
                                  params: { order: { is_settled: true } }, 
                                  data: { turbo_frame: "main_content" },
                                  class: "w-full py-3 bg-[#0066b3] text-white text-[11px] font-black hover:bg-[#005596] transition-all cursor-pointer border-none shadow-sm active:transform active:scale-95 block relative z-10" do %>
                      确定，现在结算
                    <% end %>
                  </div>
                  
                  <%# 小箭头 %>
                  <div class="absolute top-[calc(100%-6px)] left-1/2 -translate-x-1/2 w-3 h-3 bg-white border-r border-b border-slate-200 rotate-45"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      <% else %>
        <div class="bg-blue-50/50 border-2 border-dashed border-blue-200 rounded-2xl p-6 flex flex-col items-center justify-center gap-2 text-center">
          <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-[#0066b3] mb-1 border border-blue-100 shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M5 13l4 4L19 7"></path></svg>
          </div>
          <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-relaxed">
            账目已入账成功<br>
            <span class="text-[9px] font-bold text-slate-300">财务流程已锁定</span>
          </p>
        </div>
      <% end %>
    </div>
  </div>
</div>

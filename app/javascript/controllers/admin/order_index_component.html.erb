<%# app/components/admin/order_index_component.html.erb %>
<div class="space-y-6 bg-slate-50 min-h-screen no-italic font-sans" data-controller="admin--order-index-component">
  
  <%# --- 1. æœç´¢ä¸ç­›é€‰å¡ç‰‡ï¼šç´§å‡‘å‹è®¾è®¡ --- %>
  <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
    <h3 class="text-xs font-bold text-slate-700 mb-5 flex items-center gap-2 tracking-wider">
      <span class="w-1 h-3.5 bg-[#0066b3] rounded-sm"></span>
      è®¢å•ç»¼åˆæŸ¥è¯¢
    </h3>

    <%= form_with url: admin_orders_path, method: :get, class: "flex flex-wrap items-end gap-4", data: { admin__order_index_component_target: "form" } do |f| %>
      
      <%# ä¸‡èƒ½æœç´¢ä¸‹æ‹‰ %>
      <div class="w-80 group" data-controller="dropdown">
        <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-tight mb-1.5 ml-1">
          æŸ¥è¯¢ä¸»ä½“ (å®¢æˆ·/å‘˜å·¥)
        </label>
        
        <div class="relative">
          <button type="button" 
                  data-action="dropdown#toggle click@window->dropdown#hide" 
                  class="w-full flex items-center justify-between py-2 px-3 bg-slate-50 border border-slate-200 text-slate-700 text-xs rounded-md font-bold hover:border-[#0066b3] focus:ring-2 focus:ring-[#0066b3]/10 transition-all cursor-pointer shadow-sm">
            <span data-admin--order-index-component-target="searchDisplay">
              <%= 
                if params[:customer_id].present?
                  "ğŸ‘¤ å®¢æˆ·: #{@customers.find_by(id: params[:customer_id])&.name}"
                elsif params[:staff_id].present?
                  "ğŸ‘” å‘˜å·¥: #{@users.find_by(id: params[:staff_id])&.name}"
                else
                  "è¯·é€‰æ‹©æˆ–ç‚¹å‡»æœç´¢..."
                end 
              %>
            </span>
            <span class="text-slate-400 text-[10px]">â–¼</span>
          </button>

          <%# å­˜å‚¨ ID çš„éšè—åŸŸ %>
          <%= f.hidden_field :customer_id, value: params[:customer_id], data: { "admin--order-index-component-target": "customerInput" } %>
          <%= f.hidden_field :staff_id, value: params[:staff_id], data: { "admin--order-index-component-target": "userInput" } %>

          <div data-dropdown-target="menu" 
               class="hidden absolute z-50 mt-1 w-full bg-white border border-slate-200 rounded-md shadow-xl py-1 animate-in fade-in zoom-in-95 duration-100 max-h-64 overflow-y-auto">
            
            <div class="px-3 py-1.5 bg-slate-50 text-[9px] font-bold text-slate-400 border-b border-slate-100 uppercase">å®¢æˆ·åˆ—è¡¨</div>
            <% @customers.each do |c| %>
              <button type="button" 
                      data-action="click->admin--order-index-component#quickSelect dropdown#toggle"
                      data-admin--order-index-component-type-param="customer"
                      data-admin--order-index-component-id-param="<%= c.id %>"
                      data-admin--order-index-component-name-param="<%= c.name %>"
                      class="w-full text-left px-3 py-2 text-xs font-bold text-slate-600 hover:bg-[#0066b3]/5 hover:text-[#0066b3] transition-colors cursor-pointer">
                ğŸ‘¤ <%= c.name %>
              </button>
            <% end %>

            <div class="px-3 py-1.5 bg-slate-50 text-[9px] font-bold text-slate-400 border-y border-slate-100 uppercase">å‘˜å·¥åˆ—è¡¨</div>
            <% @users.each do |u| %>
              <button type="button" 
                      data-action="click->admin--order-index-component#quickSelect dropdown#toggle"
                      data-admin--order-index-component-type-param="user"
                      data-admin--order-index-component-id-param="<%= u.id %>"
                      data-admin--order-index-component-name-param="<%= u.name %>"
                      class="w-full text-left px-3 py-2 text-xs font-bold text-slate-600 hover:bg-[#0066b3]/5 hover:text-[#0066b3] transition-colors cursor-pointer">
                ğŸ‘” <%= u.name %>
              </button>
            <% end %>
          </div>
        </div>
      </div>

      <%# æ—¶é—´é€‰æ‹© %>
      <div class="flex items-end gap-2">
        <div class="w-36">
          <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-tight mb-1.5 ml-1">å¼€å§‹æ—¥æœŸ</label>
          <%= f.date_field :start_date, value: params[:start_date], onkeydown: "return false;", class: "w-full py-2 px-3 bg-slate-50 border border-slate-200 text-xs rounded-md font-bold text-slate-700 cursor-pointer shadow-sm" %>
        </div>
        <div class="w-36">
          <label class="block text-[10px] font-bold text-slate-400 uppercase tracking-tight mb-1.5 ml-1">ç»“æŸæ—¥æœŸ</label>
          <%= f.date_field :end_date, value: params[:end_date], onkeydown: "return false;", class: "w-full py-2 px-3 bg-slate-50 border border-slate-200 text-xs rounded-md font-bold text-slate-700 cursor-pointer shadow-sm" %>
        </div>
      </div>

      <%# æŒ‰é’®ç»„ %>
      <div class="flex items-center gap-3 ml-2">
        <%= f.submit "æŸ¥è¯¢", class: "px-5 py-2 bg-[#0066b3] text-white text-xs font-bold rounded-md hover:bg-[#005596] active:scale-95 transition-all cursor-pointer shadow-sm tracking-widest" %>
        <%= link_to "é‡ç½®", admin_orders_path, class: "text-[10px] font-bold text-slate-400 hover:text-slate-600 px-1 uppercase" %>
        
        <div class="w-px h-4 bg-slate-200 mx-1"></div>
        
        <%= link_to admin_orders_path(format: :xlsx, params: request.query_parameters), class: "text-[10px] font-bold text-slate-400 hover:text-[#0066b3] uppercase tracking-wider" do %>
          å¯¼å‡º
        <% end %>
      </div>
    <% end %>
  </div>

  <%# --- 2. åˆ—è¡¨å±•ç¤ºåŒº --- %>
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <div class="bg-slate-50/50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
       <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">è®¢å•äº¤æ˜“æ˜ç»†</span>
       <span class="text-[10px] font-bold text-slate-400">å…±è®¡ <%= @orders.count %> ç¬”è®¢å•, æ€»é‡‘é¢ Â¥<%= @orders.map{|item| item.amount}.sum %></span>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50/50 text-[10px] font-bold text-slate-400 uppercase tracking-[0.1em]">
          <tr>
            <th class="px-6 py-4 text-left">å•å·</th>
            <th class="px-6 py-4 text-left">å®¢æˆ·</th>
            <th class="px-6 py-4 text-left">æœåŠ¡ç±»å‹</th>
            <th class="px-6 py-4 text-left">äº§å“åˆ†ç±»</th>
            <th class="px-6 py-4 text-left">åˆ¶ä½œå‘˜</th>
            <th class="px-6 py-4 text-center">å½“å‰çŠ¶æ€</th>
            <th class="px-6 py-4 text-right">æ”¯ä»˜æ–¹å¼</th>
            <th class="px-6 py-4 text-right">äº¤æ˜“é‡‘é¢</th>
            <th class="px-6 py-4 text-right">è¿è´¹</th>
            <th class="px-6 py-4 text-right">ä¸‹å•æ—¶é—´</th>
            <th class="px-6 py-4 text-right">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 bg-white text-slate-700 font-bold">
          <% @orders.each do |order| %>
            <tr class="hover:bg-slate-50/50 transition-colors group">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <%= link_to order.order_no , admin_order_path(order), 
                            data: { turbo: false },
                            class: "text-[#0066b3] hover:text-[#005596] font-black text-sm transition-colors" %>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="flex flex-col">
                  <span class="text-sm font-bold"><%= order.customer&.name %></span>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="flex flex-col">
                  <span class="text-sm font-mono text-slate-900"><%= order.service_type %></span>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="flex flex-col">
                  <span class="text-sm font-mono text-slate-900"><%= order.category_name %></span>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="flex flex-col">
                  <span class="text-sm font-mono text-slate-900"><%= order.staff&.name %></span>
                </div>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex px-2 py-0.5 rounded text-[10px] font-bold border <%= order.is_settled ? 'bg-green-50 text-green-700 border-green-100' : 'bg-orange-50 text-orange-600 border-orange-100' %>">
                  <%= order.is_settled ? 'å·²ç»“ç®—' : 'æœªç»“ç®—' %>
                </span>
              </td>
              <td class="px-6 py-4 text-right text-sm font-mono text-slate-900">
                <%= order.payment_method %>
              </td>
              <td class="px-6 py-4 text-right text-sm font-mono text-slate-900">
                Â¥<%= number_with_precision(order.amount, precision: 2) %>
              </td>
              <td class="px-6 py-4 text-right text-sm font-mono text-slate-900">
                <%= order.delivery_fee %>
              </td>
              <td class="px-6 py-4 text-right text-[11px] text-slate-400 font-mono">
                <%= order.created_at.strftime("%Y-%m-%d %H:%M") %>
              </td>
              <td class="px-6 py-4 text-right text-[11px] text-slate-400 font-mono">
                <div class="relative group/popover">
                  <span class="text-red-400 group-hover/popover:text-red-600 font-bold cursor-help transition-colors">
                    åˆ é™¤
                  </span>

                  <div class="invisible opacity-0 group-hover/popover:visible group-hover/popover:opacity-100 
                              absolute bottom-full right-0 mb-3 z-[60] transition-all duration-200 
                              translate-y-1 group-hover/popover:translate-y-0">
                    <div class="bg-white border border-slate-200 shadow-xl rounded-lg p-2 flex items-center gap-1.5 whitespace-nowrap">
                      <%= button_to "/admin/orders/#{order.id}", 
                                    method: :delete,
                                    data: { turbo_frame: "main_content" },
                                    class: "flex items-center gap-2 px-4 py-1.5 bg-red-500 text-white text-[11px] font-bold rounded shadow-sm hover:bg-red-600 cursor-pointer border-none transition-all" do %>
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        ç¡®è®¤åˆ é™¤
                      <% end %>
                      <div class="absolute top-[calc(100%-5px)] right-4 w-2.5 h-2.5 bg-white border-r border-b border-slate-200 rotate-45"></div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <%= render Common::PagyComponent.new(pagy: @pagy) %>
  </div>
</div>
